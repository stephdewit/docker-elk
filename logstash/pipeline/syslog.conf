input {
  udp {
    port => 5514
    type => syslog
  }
}

filter {
  if [type] == "syslog" {
    if [host] == "10.1.1.254" {
      mutate { add_tag => [ "pfsense" ] }

      grok {
        match => { "message" => "<%{POSINT:syslog_pri}>%{SYSLOGTIMESTAMP:syslog_timestamp} (?:%{SYSLOGFACILITY} )?(?:%{SYSLOGHOST:logsource} )?%{SYSLOGPROG}: %{GREEDYDATA:syslog_message}" }
      }

      if [program] == "filterlog" {
        mutate { add_tag => [ "packetfilter" ] }

        grok {
          patterns_dir => "/opt/logstash/patterns"
          match => { "syslog_message" => "%{LOG_DATA}%{IP_SPECIFIC_DATA}%{IP_DATA}%{PROTOCOL_DATA}" }
        }

        if [iface] == "pppoe0" {
          geoip { source => "src_ip" }
        } else {
          geoip { source => "dest_ip" }
        }
      } else if [program] == "dhcpd" {
        if [syslog_message] =~ /^DHCPDISCOVER/ {
          grok {
            patterns_dir => "/opt/logstash/patterns"
            match => { "syslog_message" => "%{WORD:action} from %{MAC:mac_address} via %{IFACE:iface}" }
          }
        } else if [syslog_message] =~ /^DHCPOFFER/ {
          grok {
            patterns_dir => "/opt/logstash/patterns"
            match => { "syslog_message" => "%{WORD:action} on %{IP:src_ip} to %{MAC:mac_address} \(%{HOSTNAME:hostname}\) via %{IFACE:iface}" }
          }
        } else if [syslog_message] =~ /^DHCPREQUEST/ {
          grok {
            patterns_dir => "/opt/logstash/patterns"
            match => { "syslog_message" => "%{WORD:action} for %{IP:src_ip}(?: \(%{IP:dest_ip}\))? from %{MAC:mac_address}(?: \(%{HOSTNAME:hostname}\))? via %{IFACE:iface}" }
          }
        } else if [syslog_message] =~ /^DHCPACK/ {
          grok {
            patterns_dir => "/opt/logstash/patterns"
            match => { "syslog_message" => "%{WORD:action} on %{IP:src_ip} to %{MAC:mac_address}(?: \(%{HOSTNAME:hostname}\))? via %{IFACE:iface}" }
          }
        } else if [syslog_message] =~ /^DHCPRELEASE/ {
          grok {
            patterns_dir => "/opt/logstash/patterns"
            match => { "syslog_message" => "%{WORD:action} of %{IP:src_ip} from %{MAC:mac_address}(?: \(%{HOSTNAME:hostname}\))? via %{IFACE:iface} (%{WORD:result})" }
          }
        } else if [syslog_message] =~ /^DHCP/ {
          mutate { add_tag => [ "_unmanageddhcpaction" ] }
        }
      }
    } else if [message] =~ /^<\d+> -- MARK --$/ {
      grok {
        match => { "message" => "<%{POSINT:syslog_pri}> %{GREEDYDATA:syslog_message}" }
      }
    } else if [host] =~ /10\.1\.1\.[23]/ {
      mutate { add_tag => [ "synology" ] }

      grok {
        match => { "message" => "<%{POSINT:syslog_pri}>%{SYSLOGTIMESTAMP:syslog_timestamp} (?:%{SYSLOGFACILITY} )?%{SYSLOGHOST:syslog_hostname} %{SYSLOGPROG}(?: %{USERNAME:syslog_username}:)?%{SPACE}%{GREEDYDATA:syslog_message}" }
      }
    } else if [host] == "10.2.1.253" {
      mutate { add_tag => [ "tomato" ] }

      grok {
        match => { "message" => "<%{POSINT:syslog_pri}>%{SYSLOGTIMESTAMP:timestamp} (?:%{SYSLOGFACILITY} )?(?:%{SYSLOGHOST:logsource} )?%{SYSLOGPROG}: %{GREEDYDATA:syslog_message}" }
      }
    } else if [host] == "10.9.1.1" {
      mutate { add_tag => [ "dlink" ] }

      grok {
        match => { "message" => "<%{POSINT:syslog_pri}> (?:%{SYSLOGPROG}: )?%{GREEDYDATA:syslog_message}" }
      }
    } else if [host] == "10.8.1.1" {
      mutate { add_tag => [ "netgear" ] }

      grok {
        match => { "message" => "<%{POSINT:syslog_pri}>(?:%{SPACE})?%{SYSLOGBASE} (?<src_file>[\w_%!$@:.,+~-]+)\(%{POSINT:src_line}\) %{POSINT:seq} %% %{GREEDYDATA:syslog_message}" }
      }
    } else if [host] == "10.8.1.100" {
      mutate { add_tag => [ "unifi" ] }

      grok {
        match => { "message" => "<%{POSINT:syslog_pri}>?%{SYSLOGTIMESTAMP:timestamp} \(.%{WORD:firmware},%{WORD:mac_address},v(?<version>\d+(?:\.\d+)*).\) %{SYSLOGPROG}: %{GREEDYDATA:syslog_message}" }
      }

      mutate {
        gsub => ["mac_address", "^([0-9a-zA-Z]{2})([0-9a-zA-Z]{2})([0-9a-zA-Z]{2})([0-9a-zA-Z]{2})([0-9a-zA-Z]{2})([0-9a-zA-Z]{2})$", "\1:\2:\3:\4:\5:\6"]
      }
    } else {
      grok {
        match => { "message" => "<%{POSINT:syslog_pri}>(?:%{SPACE})?%{SYSLOGBASE} %{GREEDYDATA:syslog_message}" }
      }
    }

    syslog_pri { }
  }
}
